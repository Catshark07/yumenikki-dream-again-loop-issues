[gd_scene load_steps=48 format=3 uid="uid://dl7sdjmo0vbkt"]

[ext_resource type="Script" uid="uid://b1ofr4umso5jf" path="res://src/systems/scenes/game/game_scene.gd" id="1_5js63"]
[ext_resource type="PackedScene" uid="uid://c8bnpo28a373g" path="res://src/systems/camera/camera.tscn" id="2_flyuj"]
[ext_resource type="Script" uid="uid://dxx2gbg56i1ts" path="res://src/systems/sequencing/event/scene/apply_panorama.gd" id="2_ftpjc"]
[ext_resource type="Script" uid="uid://bptlrkdn0tpua" path="res://src/systems/components/overrides/wiggle.gd" id="3_alusu"]
[ext_resource type="PackedScene" uid="uid://dnh41fsltbilo" path="res://src/levels/_dream/apartment/balcony_dream.tscn" id="3_r5q3p"]
[ext_resource type="Script" uid="uid://d4mfbplpq5p5d" path="res://src/systems/sequencing/event/game/screen_transition.gd" id="4_1nhfj"]
[ext_resource type="PackedScene" uid="uid://tu7ksu6xj8wy" path="res://src/levels/_dream/apartment/room_dream.tscn" id="4_2jhc0"]
[ext_resource type="PackedScene" uid="uid://brssxovackb8b" path="res://src/levels/__ignore/animated_door.tscn" id="4_xa451"]
[ext_resource type="PackedScene" uid="uid://ryhx8o46er7i" path="res://src/player/2D/madotsuki/madotsuki.tscn" id="5_j7r18"]
[ext_resource type="Script" uid="uid://vk574kc3l7av" path="res://src/systems/sequencing/event/audio/play_sound.gd" id="5_nipjk"]
[ext_resource type="AudioStream" uid="uid://bxuxgojv4l7s3" path="res://src/audio/se/running_transition.ogg" id="6_r6s10"]
[ext_resource type="Texture2D" uid="uid://c6glk4dy75gcg" path="res://src/images/panorama/dusk.png" id="8_0oore"]
[ext_resource type="Script" uid="uid://bkadpjx8csm75" path="res://src/systems/sequencing/sequence/game/on_interact.gd" id="9_alusu"]
[ext_resource type="Shader" uid="uid://bqp8m8worpqyn" path="res://src/shaders/panorama/linear_fog.gdshader" id="9_gfwn5"]
[ext_resource type="Script" uid="uid://ctqw6a8qsvnv4" path="res://src/systems/sequencing/event/audio/play_bgm.gd" id="10_3ak1f"]
[ext_resource type="Texture2D" uid="uid://c8k1sxkde80gi" path="res://src/images/panorama/clouds.png" id="10_bl3wm"]
[ext_resource type="Script" uid="uid://cvb48ow8p04j8" path="res://src/systems/sequencing/event/call_external_event.gd" id="10_nipjk"]
[ext_resource type="Script" uid="uid://btgm8okupfro7" path="res://src/systems/region/cam_deadzone.gd" id="10_xa451"]
[ext_resource type="Shader" uid="uid://bjc3g4hpc28r1" path="res://src/shaders/screen_overlay/ocean_lights.gdshader" id="11_ai2lp"]
[ext_resource type="Script" uid="uid://jf85vmwx4pj" path="res://src/player/2D/scripts/pl_variables.gd" id="11_f4wrt"]
[ext_resource type="Script" uid="uid://qo665eecfxcw" path="res://src/systems/sequencing/event/player/teleport_sentient.gd" id="11_nipjk"]
[ext_resource type="AudioStream" uid="uid://drbxal7equ2eo" path="res://src/audio/bgm/balcony.WAV" id="11_rdrme"]
[ext_resource type="Script" uid="uid://bxh774473av7t" path="res://src/systems/interaction/interactable.gd" id="12_sb11j"]
[ext_resource type="Script" uid="uid://c1od80bn28h0l" path="res://src/systems/sequencing/sequence_interface.gd" id="12_yglpt"]
[ext_resource type="Texture2D" uid="uid://6hbdjnabl7un" path="res://src/images/panorama/hills.png" id="12_ykehj"]
[ext_resource type="Script" uid="uid://dspsbq33tl0wa" path="res://src/systems/sequencing/event/game/invoke_game_event.gd" id="13_37yy6"]
[ext_resource type="Script" uid="uid://dyaslht461mw2" path="res://src/systems/sequencing/event/game/wait_seconds.gd" id="14_xnbkh"]
[ext_resource type="Texture2D" uid="uid://tot51cpm8hrq" path="res://src/images/panorama/mountains.jpg" id="17_sb11j"]
[ext_resource type="Shader" uid="uid://co827qqsgjqt0" path="res://src/shaders/masks/mix.gdshader" id="18_3ak1f"]
[ext_resource type="PackedScene" uid="uid://cnbg0ato50rwn" path="res://src/levels/_dream/apartment/tv.tscn" id="30_r6s10"]

[sub_resource type="ShaderMaterial" id="ShaderMaterial_2004a"]

[sub_resource type="ShaderMaterial" id="ShaderMaterial_04jgb"]

[sub_resource type="Gradient" id="Gradient_nipjk"]
colors = PackedColorArray(0, 0, 0, 0, 0, 0, 0, 1)

[sub_resource type="ShaderMaterial" id="ShaderMaterial_rdrme"]
shader = ExtResource("18_3ak1f")
shader_parameter/transparency = 0.40000000596048

[sub_resource type="FastNoiseLite" id="FastNoiseLite_5kgwf"]

[sub_resource type="NoiseTexture2D" id="NoiseTexture2D_y6mui"]
noise = SubResource("FastNoiseLite_5kgwf")
seamless = true

[sub_resource type="ShaderMaterial" id="ShaderMaterial_6a2ja"]
shader = ExtResource("9_gfwn5")
shader_parameter/dirX = -1.0
shader_parameter/dirY = 0.0
shader_parameter/scroll_speed = 0.05
shader_parameter/initial_uv_offset = Vector2(0, -0.68)
shader_parameter/offset_strength = 0.0
shader_parameter/offset_strength_influence = Vector2(1, 1)
shader_parameter/overlay_modulate = Color(1, 1, 1, 1)
shader_parameter/transparency = 0.0
shader_parameter/optional_gradient = false
shader_parameter/noise = SubResource("NoiseTexture2D_y6mui")
shader_parameter/color_overlay = Color(0.592351, 0.580878, 0.381491, 1)
shader_parameter/color_overlay_intensity = 0.66

[sub_resource type="RectangleShape2D" id="RectangleShape2D_sb11j"]
size = Vector2(480, 270)

[sub_resource type="RectangleShape2D" id="RectangleShape2D_r6s10"]
size = Vector2(32, 16)

[sub_resource type="Gradient" id="Gradient_r6s10"]
offsets = PackedFloat32Array(0, 0.7003155)
colors = PackedColorArray(0, 0, 0, 0, 0, 0, 0, 1)

[sub_resource type="RectangleShape2D" id="RectangleShape2D_nipjk"]
size = Vector2(32, 16)

[sub_resource type="Resource" id="Resource_r6s10"]
resource_local_to_scene = true
resource_name = "pl_variables"
script = ExtResource("11_f4wrt")

[sub_resource type="Gradient" id="Gradient_sb11j"]
offsets = PackedFloat32Array(0, 0.12802768, 0.2283737, 0.52249134)
colors = PackedColorArray(1, 1, 1, 1, 0.9748891, 0.77652675, 0.74777097, 1, 0.29923284, 0.17736802, 0.028306946, 1, 0, 0, 0, 1)

[sub_resource type="GradientTexture2D" id="GradientTexture2D_3ak1f"]
gradient = SubResource("Gradient_sb11j")
fill_to = Vector2(0, 1)

[sub_resource type="FastNoiseLite" id="FastNoiseLite_rdrme"]

[sub_resource type="NoiseTexture2D" id="NoiseTexture2D_w758d"]
noise = SubResource("FastNoiseLite_rdrme")

[sub_resource type="ShaderMaterial" id="ShaderMaterial_alusu"]
shader = ExtResource("11_ai2lp")
shader_parameter/initial_uv_offset = Vector2(0, 0)
shader_parameter/offset_strength = 0.0
shader_parameter/offset_strength_influence = Vector2(1, 1)
shader_parameter/opacity = 1.0
shader_parameter/noise = SubResource("NoiseTexture2D_w758d")
shader_parameter/scroll_speed = 0.05
shader_parameter/gradient = SubResource("GradientTexture2D_3ak1f")
shader_parameter/rot_radians = 0.45
shader_parameter/ray_strength = 1.225

[node name="room" type="Node" node_paths=PackedStringArray("seq_initial", "seq_free")]
script = ExtResource("1_5js63")
seq_initial = NodePath("on_initial")
seq_free = NodePath("on_free")
load_transition = SubResource("ShaderMaterial_2004a")
unload_transition = SubResource("ShaderMaterial_04jgb")
metadata/_custom_type_script = "uid://b1ofr4umso5jf"

[node name="rooms_traverse" type="Node" parent="." node_paths=PackedStringArray("order", "front", "back")]
script = ExtResource("12_yglpt")
order = [NodePath("request_cutscene_start"), NodePath("fade_in"), NodePath("play_running_sound"), NodePath("wait_1_sec")]
front = NodePath("request_cutscene_start")
back = NodePath("wait_1_sec")
metadata/_custom_type_script = "uid://c1od80bn28h0l"

[node name="request_cutscene_start" type="Node" parent="rooms_traverse" node_paths=PackedStringArray("next")]
script = ExtResource("13_37yy6")
event_id = "CUTSCENE_START_REQUEST"
next = NodePath("../fade_in")
metadata/_custom_type_script = "uid://dspsbq33tl0wa"

[node name="fade_in" type="Node" parent="rooms_traverse" node_paths=PackedStringArray("prev", "next")]
process_mode = 4
script = ExtResource("4_1nhfj")
gradient = SubResource("Gradient_nipjk")
prev = NodePath("../request_cutscene_start")
next = NodePath("../play_running_sound")
metadata/_custom_type_script = "uid://s0vrbpe4jy34"

[node name="play_running_sound" type="Node" parent="rooms_traverse" node_paths=PackedStringArray("prev", "next")]
process_mode = 4
script = ExtResource("5_nipjk")
sound = ExtResource("6_r6s10")
prev = NodePath("../fade_in")
next = NodePath("../wait_1_sec")
metadata/_custom_type_script = "uid://vk574kc3l7av"

[node name="wait_1_sec" type="Node" parent="rooms_traverse" node_paths=PackedStringArray("prev")]
script = ExtResource("14_xnbkh")
prev = NodePath("../play_running_sound")
metadata/_custom_type_script = "uid://dyaslht461mw2"

[node name="on_initial" type="Node" parent="." node_paths=PackedStringArray("order", "front", "back")]
script = ExtResource("12_yglpt")
order = [NodePath("bgm"), NodePath("panorama (top_layer)")]
front = NodePath("bgm")
back = NodePath("panorama (top_layer)")

[node name="bgm" type="Node" parent="on_initial" node_paths=PackedStringArray("next")]
process_mode = 4
script = ExtResource("10_3ak1f")
stream = ExtResource("11_rdrme")
pitch = 0.9
next = NodePath("../panorama (top_layer)")
metadata/_custom_type_script = "uid://0v2nidb8jsha"

[node name="panorama (top_layer)" type="Node" parent="on_initial" node_paths=PackedStringArray("subviewport", "pivot", "prev")]
script = ExtResource("2_ftpjc")
subviewport = NodePath("subviewport")
pivot = NodePath("pivot")
prev = NodePath("../bgm")
metadata/_custom_type_script = "uid://0v2nidb8jsha"

[node name="pivot" type="Marker2D" parent="on_initial/panorama (top_layer)"]

[node name="subviewport" type="SubViewport" parent="on_initial/panorama (top_layer)"]
own_world_3d = true
transparent_bg = true
canvas_item_default_texture_filter = 0
canvas_item_default_texture_repeat = 2
size = Vector2i(480, 270)
size_2d_override = Vector2i(480, 270)

[node name="mountains" type="Sprite2D" parent="on_initial/panorama (top_layer)/subviewport"]
use_parent_material = true
position = Vector2(240, 200)
texture = ExtResource("17_sb11j")
flip_h = true

[node name="dusk" type="Sprite2D" parent="on_initial/panorama (top_layer)/subviewport"]
material = SubResource("ShaderMaterial_rdrme")
position = Vector2(240, 128)
texture = ExtResource("8_0oore")

[node name="clouds" type="Sprite2D" parent="on_initial/panorama (top_layer)/subviewport"]
material = SubResource("ShaderMaterial_6a2ja")
use_parent_material = true
position = Vector2(240, 136)
texture = ExtResource("10_bl3wm")

[node name="hills" type="Sprite2D" parent="on_initial/panorama (top_layer)/subviewport"]
position = Vector2(240, 260)
texture = ExtResource("12_ykehj")

[node name="on_free" type="Node" parent="."]
script = ExtResource("12_yglpt")

[node name="y_order" type="Node2D" parent="."]
y_sort_enabled = true

[node name="camera_handler" parent="y_order" instance=ExtResource("2_flyuj")]
position = Vector2(228, 84)

[node name="overlay_3" parent="y_order/camera_handler/marker/camera" index="2"]
offset_top = -136.0
offset_bottom = 134.0

[node name="wiggle" type="Node" parent="y_order/camera_handler/marker/camera/components_receiver" index="0"]
script = ExtResource("3_alusu")
metadata/_custom_type_script = "uid://bptlrkdn0tpua"

[node name="room" parent="y_order" instance=ExtResource("4_2jhc0")]
position = Vector2(0, -480)
metadata/_custom_type_script = "uid://bau5lvtg1mbkj"

[node name="balcony" parent="y_order" instance=ExtResource("3_r5q3p")]
position = Vector2(108, 0)

[node name="deadzone" type="Area2D" parent="y_order/balcony" node_paths=PackedStringArray("rect")]
process_mode = 3
position = Vector2(148, 136)
collision_layer = 0
collision_mask = 1073741824
script = ExtResource("10_xa451")
rect = NodePath("rect")
metadata/_custom_type_script = "uid://btgm8okupfro7"

[node name="rect" type="CollisionShape2D" parent="y_order/balcony/deadzone"]
shape = SubResource("RectangleShape2D_sb11j")
debug_color = Color(0.2, 0, 0.7, 0.2)

[node name="to_nexus" parent="y_order" instance=ExtResource("4_xa451")]
position = Vector2(208, -412)

[node name="travel_to_scene" parent="y_order/to_nexus/on_interact" index="4"]
scene_path = "uid://dl25joalnmaxt"
connection_id = "nexus"

[node name="spawn_point" parent="y_order/to_nexus" index="1"]
scene_path = "uid://dl25joalnmaxt"
connection_id = "nexus"

[node name="tv" parent="y_order" instance=ExtResource("30_r6s10")]
position = Vector2(176, -392)

[node name="to_balcony" type="Area2D" parent="y_order" node_paths=PackedStringArray("rect")]
process_mode = 3
position = Vector2(256, -320)
collision_layer = 2
collision_mask = 1073741824
script = ExtResource("12_sb11j")
secret = true
area_trgger = true
rect = NodePath("rect")
metadata/_custom_type_script = "uid://bxh774473av7t"

[node name="rect" type="CollisionShape2D" parent="y_order/to_balcony"]
position = Vector2(0, 40)
shape = SubResource("RectangleShape2D_r6s10")
debug_color = Color(0.2, 0, 0.7, 0.2)

[node name="on_enter" type="Node" parent="y_order/to_balcony" node_paths=PackedStringArray("order", "front", "back")]
script = ExtResource("9_alusu")
order = [NodePath("call_traverse_seq"), NodePath("teleport"), NodePath("fade_out"), NodePath("request_cutscene_end")]
front = NodePath("call_traverse_seq")
back = NodePath("request_cutscene_end")
metadata/_custom_type_script = "uid://bkadpjx8csm75"

[node name="call_traverse_seq" type="Node" parent="y_order/to_balcony/on_enter" node_paths=PackedStringArray("event", "next")]
script = ExtResource("10_nipjk")
event = NodePath("../../../../rooms_traverse")
next = NodePath("../teleport")
metadata/_custom_type_script = "uid://cvb48ow8p04j8"

[node name="teleport" type="Node" parent="y_order/to_balcony/on_enter" node_paths=PackedStringArray("sentient", "marker_A", "marker_B", "prev", "next")]
process_mode = 1
script = ExtResource("11_nipjk")
dis_vector = Vector2i(112, 416)
sentient = NodePath("../../../madotsuki")
marker_A = NodePath("marker_A")
marker_B = NodePath("marker_B")
prev = NodePath("../call_traverse_seq")
next = NodePath("../fade_out")
metadata/_custom_type_script = "uid://qo665eecfxcw"

[node name="marker_A" type="Marker2D" parent="y_order/to_balcony/on_enter/teleport"]
position = Vector2(256, -280)

[node name="marker_B" type="Marker2D" parent="y_order/to_balcony/on_enter/teleport"]
position = Vector2(368, 136)

[node name="fade_out" type="Node" parent="y_order/to_balcony/on_enter" node_paths=PackedStringArray("prev", "next")]
process_mode = 4
script = ExtResource("4_1nhfj")
fade_type = 1
gradient = SubResource("Gradient_r6s10")
wait_til_finished = false
prev = NodePath("../teleport")
next = NodePath("../request_cutscene_end")
metadata/_custom_type_script = "uid://s0vrbpe4jy34"

[node name="request_cutscene_end" type="Node" parent="y_order/to_balcony/on_enter" node_paths=PackedStringArray("prev")]
script = ExtResource("13_37yy6")
event_id = "CUTSCENE_END_REQUEST"
prev = NodePath("../fade_out")
metadata/_custom_type_script = "uid://dspsbq33tl0wa"

[node name="to_room" type="Area2D" parent="y_order" node_paths=PackedStringArray("rect")]
process_mode = 3
position = Vector2(368, 120)
collision_layer = 2
collision_mask = 2147483648
script = ExtResource("12_sb11j")
secret = true
centre_trigger = true
rect = NodePath("rect")
metadata/_custom_type_script = "uid://bxh774473av7t"

[node name="rect" type="CollisionShape2D" parent="y_order/to_room"]
shape = SubResource("RectangleShape2D_nipjk")
debug_color = Color(0.2, 0, 0.7, 0.2)

[node name="on_enter" type="Node" parent="y_order/to_room" node_paths=PackedStringArray("order", "front", "back")]
script = ExtResource("9_alusu")
order = [NodePath("call_traverse_seq"), NodePath("teleport"), NodePath("fade_out"), NodePath("request_cutscene_end")]
front = NodePath("call_traverse_seq")
back = NodePath("request_cutscene_end")
metadata/_custom_type_script = "uid://bkadpjx8csm75"

[node name="call_traverse_seq" type="Node" parent="y_order/to_room/on_enter" node_paths=PackedStringArray("event", "next")]
script = ExtResource("10_nipjk")
event = NodePath("../../../../rooms_traverse")
next = NodePath("../teleport")
metadata/_custom_type_script = "uid://cvb48ow8p04j8"

[node name="teleport" type="Node" parent="y_order/to_room/on_enter" node_paths=PackedStringArray("sentient", "marker_A", "marker_B", "prev", "next")]
process_mode = 1
script = ExtResource("11_nipjk")
dis_vector = Vector2i(-112, -432)
sentient = NodePath("../../../madotsuki")
marker_A = NodePath("marker_A")
marker_B = NodePath("marker_B")
prev = NodePath("../call_traverse_seq")
next = NodePath("../fade_out")
metadata/_custom_type_script = "uid://qo665eecfxcw"

[node name="marker_A" type="Marker2D" parent="y_order/to_room/on_enter/teleport"]
position = Vector2(368, 120)

[node name="marker_B" type="Marker2D" parent="y_order/to_room/on_enter/teleport"]
position = Vector2(256, -312)

[node name="fade_out" type="Node" parent="y_order/to_room/on_enter" node_paths=PackedStringArray("prev", "next")]
process_mode = 4
script = ExtResource("4_1nhfj")
fade_type = 1
gradient = SubResource("Gradient_r6s10")
wait_til_finished = false
prev = NodePath("../teleport")
next = NodePath("../request_cutscene_end")
metadata/_custom_type_script = "uid://s0vrbpe4jy34"

[node name="request_cutscene_end" type="Node" parent="y_order/to_room/on_enter" node_paths=PackedStringArray("prev")]
script = ExtResource("13_37yy6")
event_id = "CUTSCENE_END_REQUEST"
prev = NodePath("../fade_out")
metadata/_custom_type_script = "uid://dspsbq33tl0wa"

[node name="madotsuki" parent="y_order" instance=ExtResource("5_j7r18")]
position = Vector2(300, 144)
values = SubResource("Resource_r6s10")
metadata/_custom_type_script = "uid://bau5lvtg1mbkj"

[node name="audio_listener" parent="y_order/madotsuki" index="5"]
current = false

[node name="pl_loop" parent="y_order/madotsuki" index="11" node_paths=PackedStringArray("children")]
children = [NodePath("../sb_components"), NodePath("../stamina_fsm"), NodePath("../stance_fsm"), NodePath("../movement_fsm"), NodePath("../nav"), NodePath("../audio_listener"), NodePath("../sprite_container"), NodePath("../collision"), NodePath("../centre_trigger"), NodePath("../region_trigger"), NodePath("../sound_player")]

[node name="sun" type="ColorRect" parent="y_order"]
material = SubResource("ShaderMaterial_alusu")
custom_minimum_size = Vector2(480, 270)
anchors_preset = 15
anchor_right = 1.0
anchor_bottom = 1.0
offset_left = 16.0
offset_right = 496.0
offset_bottom = 270.0
grow_horizontal = 2
grow_vertical = 2

[node name="overlay_modulate" type="CanvasModulate" parent="y_order"]
position = Vector2(0, 32)
color = Color(0.724289, 0.618342, 0.602991, 1)

[editable path="y_order/camera_handler"]
[editable path="y_order/to_nexus"]
[editable path="y_order/madotsuki"]
