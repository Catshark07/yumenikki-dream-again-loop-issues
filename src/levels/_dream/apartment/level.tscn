[gd_scene load_steps=40 format=3 uid="uid://dl7sdjmo0vbkt"]

[ext_resource type="Script" uid="uid://b1ofr4umso5jf" path="res://src/systems/scenes/game/game_scene.gd" id="1_5js63"]
[ext_resource type="PackedScene" uid="uid://c8bnpo28a373g" path="res://src/systems/camera/camera.tscn" id="2_flyuj"]
[ext_resource type="Script" uid="uid://dxx2gbg56i1ts" path="res://src/systems/sequencing/event/scene/apply_panorama.gd" id="2_ftpjc"]
[ext_resource type="Script" uid="uid://bptlrkdn0tpua" path="res://src/systems/components/overrides/wiggle.gd" id="3_alusu"]
[ext_resource type="PackedScene" uid="uid://dnh41fsltbilo" path="res://src/levels/_dream/apartment/balcony_dream.tscn" id="3_r5q3p"]
[ext_resource type="PackedScene" uid="uid://tu7ksu6xj8wy" path="res://src/levels/_dream/apartment/room_dream.tscn" id="4_2jhc0"]
[ext_resource type="PackedScene" uid="uid://brssxovackb8b" path="res://src/levels/__ignore/animated_door.tscn" id="4_xa451"]
[ext_resource type="PackedScene" uid="uid://ryhx8o46er7i" path="res://src/player/2D/madotsuki/madotsuki.tscn" id="5_j7r18"]
[ext_resource type="Script" uid="uid://bau5lvtg1mbkj" path="res://src/systems/interaction/door_inscene.gd" id="6_qk8hb"]
[ext_resource type="Script" uid="uid://ofyfa3d6ql28" path="res://src/systems/components/independent/spawn_point.gd" id="7_xa451"]
[ext_resource type="Texture2D" uid="uid://c6glk4dy75gcg" path="res://src/images/panorama/dusk.png" id="8_0oore"]
[ext_resource type="Shader" uid="uid://bqp8m8worpqyn" path="res://src/shaders/panorama/linear_fog.gdshader" id="9_gfwn5"]
[ext_resource type="Script" uid="uid://ctqw6a8qsvnv4" path="res://src/systems/sequencing/event/audio/play_bgm.gd" id="10_3ak1f"]
[ext_resource type="Texture2D" uid="uid://c8k1sxkde80gi" path="res://src/images/panorama/clouds.png" id="10_bl3wm"]
[ext_resource type="Shader" uid="uid://bjc3g4hpc28r1" path="res://src/shaders/screen_overlay/ocean_lights.gdshader" id="11_ai2lp"]
[ext_resource type="AudioStream" uid="uid://drbxal7equ2eo" path="res://src/audio/bgm/balcony.WAV" id="11_rdrme"]
[ext_resource type="Script" uid="uid://c1od80bn28h0l" path="res://src/systems/sequencing/sequence_interface.gd" id="12_yglpt"]
[ext_resource type="Texture2D" uid="uid://6hbdjnabl7un" path="res://src/images/panorama/hills.png" id="12_ykehj"]
[ext_resource type="Script" uid="uid://dspsbq33tl0wa" path="res://src/systems/sequencing/event/game/invoke_game_event.gd" id="13_37yy6"]
[ext_resource type="Script" uid="uid://d1ojbn5jneejv" path="res://src/systems/sequencing/event/node/set_property.gd" id="13_yglpt"]
[ext_resource type="Texture2D" uid="uid://v1tx4oh6hb3y" path="res://src/player/2D/madotsuki/display/default/_RESET_match.png" id="14_7gtoe"]
[ext_resource type="Script" uid="uid://ceoifexmpm3o5" path="res://src/systems/sequencing/event/node/call_function.gd" id="14_hh4cm"]
[ext_resource type="Script" uid="uid://dyaslht461mw2" path="res://src/systems/sequencing/event/game/wait_seconds.gd" id="14_xnbkh"]
[ext_resource type="Texture2D" uid="uid://dvmf5dneeyi23" path="res://src/player/2D/madotsuki/display/default/sit.png" id="15_xww4u"]
[ext_resource type="Script" uid="uid://0li2ud4tbkf5" path="res://src/systems/scenes/custom_properties.gd" id="24_3ak1f"]
[ext_resource type="Script" uid="uid://bdm7kig80eqqk" path="res://src/systems/save/node/save_properties.gd" id="25_rdrme"]
[ext_resource type="Script" uid="uid://b6ilkvabn22lp" path="res://src/systems/sequencing/sequence/conditional/if_expression.gd" id="26_w758d"]

[sub_resource type="ShaderMaterial" id="ShaderMaterial_2004a"]

[sub_resource type="ShaderMaterial" id="ShaderMaterial_04jgb"]

[sub_resource type="RectangleShape2D" id="RectangleShape2D_qk8hb"]
size = Vector2(16, 24)

[sub_resource type="RectangleShape2D" id="RectangleShape2D_f4wrt"]
size = Vector2(16, 16)

[sub_resource type="FastNoiseLite" id="FastNoiseLite_5kgwf"]

[sub_resource type="NoiseTexture2D" id="NoiseTexture2D_y6mui"]
noise = SubResource("FastNoiseLite_5kgwf")
seamless = true

[sub_resource type="ShaderMaterial" id="ShaderMaterial_6a2ja"]
shader = ExtResource("9_gfwn5")
shader_parameter/dirX = -1.0
shader_parameter/dirY = 0.0
shader_parameter/scroll_speed = 0.05
shader_parameter/initial_uv_offset = Vector2(0, -0.68)
shader_parameter/snapped_val = 0.0016
shader_parameter/offset_strength = 0.0
shader_parameter/offset_strength_influence = Vector2(1, 1)
shader_parameter/overlay_modulate = Color(0, 0, 0, 1)
shader_parameter/transparency = 0.51
shader_parameter/optional_gradient = false
shader_parameter/noise = SubResource("NoiseTexture2D_y6mui")
shader_parameter/color_overlay = Color(0.592351, 0.580878, 0.381491, 1)
shader_parameter/color_overlay_intensity = 0.66

[sub_resource type="Gradient" id="Gradient_pxjhu"]
offsets = PackedFloat32Array(0, 0.817857, 1)
colors = PackedColorArray(0, 0, 0, 1, 0.33793, 0.279863, 0.152897, 1, 0.950841, 0.744124, 0.439594, 1)

[sub_resource type="GradientTexture2D" id="GradientTexture2D_rho35"]
gradient = SubResource("Gradient_pxjhu")
fill_from = Vector2(0, 0.269231)
fill_to = Vector2(0, 1)

[sub_resource type="FastNoiseLite" id="FastNoiseLite_3awuu"]

[sub_resource type="NoiseTexture2D" id="NoiseTexture2D_8cbwq"]
noise = SubResource("FastNoiseLite_3awuu")

[sub_resource type="ShaderMaterial" id="ShaderMaterial_jyr07"]
shader = ExtResource("11_ai2lp")
shader_parameter/initial_uv_offset = Vector2(0, 0)
shader_parameter/snapped_val = 0.0016
shader_parameter/offset_strength = 0.05
shader_parameter/offset_strength_influence = Vector2(1, 1)
shader_parameter/opacity = 1.0
shader_parameter/noise = SubResource("NoiseTexture2D_8cbwq")
shader_parameter/scroll_speed = 0.015
shader_parameter/gradient = SubResource("GradientTexture2D_rho35")
shader_parameter/ray_strength = 1.225

[node name="room" type="Node2D" node_paths=PackedStringArray("seq_initial", "seq_free", "scene_objects")]
script = ExtResource("1_5js63")
seq_initial = NodePath("on_initial")
seq_free = NodePath("on_free")
scene_objects = [NodePath("on_initial"), NodePath("on_free")]
load_transition = SubResource("ShaderMaterial_2004a")
unload_transition = SubResource("ShaderMaterial_04jgb")
metadata/_custom_type_script = "uid://b1ofr4umso5jf"

[node name="camera" parent="." instance=ExtResource("2_flyuj")]

[node name="Wiggle" type="Node" parent="camera/marker/camera/components_receiver" index="0"]
script = ExtResource("3_alusu")
metadata/_custom_type_script = "uid://bptlrkdn0tpua"

[node name="room" parent="." instance=ExtResource("4_2jhc0")]
position = Vector2(0, -480)
metadata/_custom_type_script = "uid://bau5lvtg1mbkj"

[node name="animated_door" parent="room" instance=ExtResource("4_xa451")]
position = Vector2(204, 68)

[node name="scene_traversal" parent="room/animated_door/on_interact/travel_to_scene" index="0"]
scene_path = "uid://dl25joalnmaxt"
connection_id = "apartment"

[node name="spawn_point" parent="room/animated_door" index="2"]
scene_path = "uid://dl25joalnmaxt"
connection_id = "apartment"

[node name="to_balcony" type="Area2D" parent="room" node_paths=PackedStringArray("spawn_point", "target_door", "rect")]
position = Vector2(256, 188)
collision_layer = 2147483648
collision_mask = 2147483648
script = ExtResource("6_qk8hb")
spawn_point = NodePath("spawn_point")
target_door = NodePath("../../balcony/to_room")
parallel = true
secret = true
area = true
only_once = true
rect = NodePath("rect")
metadata/_custom_type_script = "uid://bau5lvtg1mbkj"

[node name="rect" type="CollisionShape2D" parent="room/to_balcony"]
shape = SubResource("RectangleShape2D_qk8hb")
debug_color = Color(0.2, 0, 0.7, 0.2)

[node name="spawn_point" type="Node2D" parent="room/to_balcony" node_paths=PackedStringArray("parent_instead_of_self")]
position = Vector2(0, -20)
script = ExtResource("7_xa451")
parent_instead_of_self = NodePath("../../../balcony")

[node name="balcony" parent="." instance=ExtResource("3_r5q3p")]

[node name="madotsuki" parent="balcony" instance=ExtResource("5_j7r18")]
position = Vector2(192, 144)
metadata/_custom_type_script = "uid://bau5lvtg1mbkj"

[node name="audio_listener" parent="balcony/madotsuki" index="5"]
current = false

[node name="to_room" type="Area2D" parent="balcony" node_paths=PackedStringArray("spawn_point", "target_door", "rect")]
position = Vector2(256, 128)
collision_layer = 2147483648
collision_mask = 2147483648
script = ExtResource("6_qk8hb")
spawn_point = NodePath("spawn_point")
target_door = NodePath("../../room/to_balcony")
parallel = true
secret = true
area = true
only_once = true
rect = NodePath("rect")
metadata/_custom_type_script = "uid://bau5lvtg1mbkj"

[node name="rect" type="CollisionShape2D" parent="balcony/to_room"]
shape = SubResource("RectangleShape2D_f4wrt")
debug_color = Color(0.2, 0, 0.7, 0.2)

[node name="spawn_point" type="Node2D" parent="balcony/to_room" node_paths=PackedStringArray("parent_instead_of_self")]
position = Vector2(0, 12)
script = ExtResource("7_xa451")
parent_instead_of_self = NodePath("../..")

[node name="overlay_modulate" type="CanvasModulate" parent="."]
position = Vector2(0, 32)
color = Color(0.724289, 0.618342, 0.602991, 1)

[node name="set_dream_start_to_true" type="Node" parent="." node_paths=PackedStringArray("properties_saver")]
script = ExtResource("24_3ak1f")
properties = Dictionary[String, Variant]({
"dream_start": false
})
properties_saver = NodePath("save_properties")
metadata/_custom_type_script = "uid://0li2ud4tbkf5"

[node name="save_properties" type="Node" parent="set_dream_start_to_true"]
script = ExtResource("25_rdrme")
properties = PackedStringArray("properties")
global = true

[node name="on_initial" type="Node" parent="."]
script = ExtResource("12_yglpt")

[node name="bgm" type="Node" parent="on_initial" node_paths=PackedStringArray("next")]
script = ExtResource("10_3ak1f")
stream = ExtResource("11_rdrme")
pitch = 0.9
next = NodePath("../panorama (top_layer)")
metadata/_custom_type_script = "uid://0v2nidb8jsha"

[node name="panorama (top_layer)" type="SubViewport" parent="on_initial"]
own_world_3d = true
transparent_bg = true
canvas_item_default_texture_filter = 0
canvas_item_default_texture_repeat = 2
size = Vector2i(480, 270)
size_2d_override = Vector2i(480, 270)
script = ExtResource("2_ftpjc")

[node name="Dusk" type="Sprite2D" parent="on_initial/panorama (top_layer)"]
use_parent_material = true
position = Vector2(240, 128)
texture = ExtResource("8_0oore")

[node name="Clouds" type="Sprite2D" parent="on_initial/panorama (top_layer)"]
material = SubResource("ShaderMaterial_6a2ja")
use_parent_material = true
position = Vector2(240, 136)
texture = ExtResource("10_bl3wm")

[node name="ColorRect" type="ColorRect" parent="on_initial/panorama (top_layer)"]
material = SubResource("ShaderMaterial_jyr07")
anchors_preset = 15
anchor_right = 1.0
anchor_bottom = 1.0
grow_horizontal = 2
grow_vertical = 2

[node name="Parallax2D" type="Parallax2D" parent="on_initial/panorama (top_layer)"]
scroll_scale = Vector2(0.51, -1.5)
scroll_offset = Vector2(240, 260)

[node name="Hills" type="Sprite2D" parent="on_initial/panorama (top_layer)/Parallax2D"]
texture = ExtResource("12_ykehj")

[node name="if_dream_just_started" type="Node" parent="on_initial" node_paths=PackedStringArray("input_objects")]
script = ExtResource("26_w758d")
expression = "!flag.properties[\"dream_start\"]"
input_objects = {
"flag": NodePath("../../set_dream_start_to_true")
}
metadata/_custom_type_script = "uid://br7tiv3hm32fy"

[node name="request_cutscene_start" type="Node" parent="on_initial/if_dream_just_started" node_paths=PackedStringArray("next")]
script = ExtResource("13_37yy6")
event_id = "CUTSCENE_START_REQUEST"
next = NodePath("../set_pl_bypass_active")
metadata/_custom_type_script = "uid://0v2nidb8jsha"

[node name="set_pl_bypass_active" type="Node" parent="on_initial/if_dream_just_started" node_paths=PackedStringArray("node")]
script = ExtResource("14_hh4cm")
node = NodePath("../../../balcony/madotsuki/sb_components")
method_name = "set_bypass"
method_info = {
"args": Array[Dictionary]([{
"class_name": &"",
"hint": 0,
"hint_string": "",
"name": "_bypass",
"type": 1,
"usage": 0
}]),
"default_args": [],
"flags": 1,
"id": 0,
"name": "set_bypass",
"return": {
"class_name": &"",
"hint": 0,
"hint_string": "",
"name": "",
"type": 0,
"usage": 6
}
}
internal_args = Dictionary[String, Variant]({
"_bypass": true
})
metadata/_custom_type_script = "uid://0v2nidb8jsha"

[node name="set_pl_sit_spr" type="Node" parent="on_initial/if_dream_just_started" node_paths=PackedStringArray("node", "next", "prev")]
process_mode = 4
script = ExtResource("13_yglpt")
node = NodePath("../../../balcony/madotsuki")
property_name = "texture"
property_info = {
"class_name": &"Texture2D",
"hint": 17,
"hint_string": "Texture2D",
"name": "texture",
"type": 24,
"usage": 6
}
property_value = ExtResource("14_7gtoe")
new_value = ExtResource("15_xww4u")
next = NodePath("../set_pl_spr_idx")
prev = NodePath("../set_pl_bypass_active")
metadata/_custom_type_script = "uid://0v2nidb8jsha"

[node name="set_pl_spr_idx" type="Node" parent="on_initial/if_dream_just_started" node_paths=PackedStringArray("node", "next", "prev")]
process_mode = 4
script = ExtResource("13_yglpt")
node = NodePath("../../../balcony/madotsuki")
property_name = "progress"
property_info = {
"class_name": &"",
"hint": 0,
"hint_string": "",
"name": "progress",
"type": 2,
"usage": 4102
}
property_value = 0
new_value = 6
next = NodePath("../wait")
prev = NodePath("../set_pl_sit_spr")
metadata/_custom_type_script = "uid://0v2nidb8jsha"

[node name="wait" type="Node" parent="on_initial/if_dream_just_started" node_paths=PackedStringArray("next", "prev")]
script = ExtResource("14_xnbkh")
seconds = 5.0
next = NodePath("../set_pl_bypass_inactive")
prev = NodePath("../set_pl_spr_idx")
metadata/_custom_type_script = "uid://0v2nidb8jsha"

[node name="set_pl_bypass_inactive" type="Node" parent="on_initial/if_dream_just_started" node_paths=PackedStringArray("node")]
script = ExtResource("14_hh4cm")
node = NodePath("../../../balcony/madotsuki/sb_components")
method_name = "set_bypass"
method_info = {
"args": Array[Dictionary]([{
"class_name": &"",
"hint": 0,
"hint_string": "",
"name": "_bypass",
"type": 1,
"usage": 0
}]),
"default_args": [],
"flags": 1,
"id": 0,
"name": "set_bypass",
"return": {
"class_name": &"",
"hint": 0,
"hint_string": "",
"name": "",
"type": 0,
"usage": 6
}
}
internal_args = Dictionary[String, Variant]({
"_bypass": false
})
metadata/_custom_type_script = "uid://0v2nidb8jsha"

[node name="request_cutscene_end" type="Node" parent="on_initial/if_dream_just_started" node_paths=PackedStringArray("next", "prev")]
script = ExtResource("13_37yy6")
event_id = "CUTSCENE_END_REQUEST"
next = NodePath("../raise_flag")
prev = NodePath("../set_pl_bypass_inactive")
metadata/_custom_type_script = "uid://0v2nidb8jsha"

[node name="raise_flag" type="Node" parent="on_initial/if_dream_just_started" node_paths=PackedStringArray("node", "prev")]
process_mode = 4
script = ExtResource("13_yglpt")
node = NodePath("../../../set_dream_start_to_true")
property_name = "properties"
property_info = {
"class_name": &"",
"hint": 23,
"hint_string": "4:;0:",
"name": "properties",
"type": 27,
"usage": 4102
}
property_value = Dictionary[String, Variant]({
"dream_start": false
})
new_value = Dictionary[String, Variant]({
"dream_start": true
})
prev = NodePath("../request_cutscene_end")
metadata/_custom_type_script = "uid://0v2nidb8jsha"

[node name="on_free" type="Node" parent="."]
script = ExtResource("12_yglpt")

[editable path="camera"]
[editable path="room/animated_door"]
[editable path="balcony/madotsuki"]
